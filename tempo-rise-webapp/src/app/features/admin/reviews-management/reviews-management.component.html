<div class="container mx-auto px-4 py-6">
  <div class="bg-[var(--surface)] rounded-lg shadow-md p-6">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div>
              <h2 class="text-2xl font-bold text-[var(--text)]">REVIEWS</h2>
          </div>
      </div>

      <!-- Stats Cards Row -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <!-- Total Reviews Card -->
          <div class="bg-[var(--surface)] border border-[var(--border)] rounded-lg p-4 shadow-sm">
              <div class="flex justify-between items-start">
                  <div>
                      <p class="text-sm text-[var(--text-secondary)]">Total Reviews</p>
                      <p class="text-2xl font-bold text-[var(--text)]">{{totalElements()}}</p>
                  </div>
                  <div class="flex items-center">
                    <span [class.text-green-500]="hasIncreased(currentWeekReviews, lastWeekReviews)"
                          [class.text-red-500]="!hasIncreased(currentWeekReviews, lastWeekReviews)"
                          class="text-sm font-medium flex items-center">
                        <svg [class.rotate-180]="!hasIncreased(currentWeekReviews, lastWeekReviews)"
                             class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                        {{ reviewChangePercentage | number:'1.0-1' }}% vs last week
                    </span>
                </div> 
              </div>
          </div>

          <!-- Average Rating Card -->
          <div class="bg-[var(--surface)] border border-[var(--border)] rounded-lg p-4 shadow-sm">
              <div class="flex justify-between items-start">
                  <div>
                      <p class="text-sm text-[var(--text-secondary)]">Average Rating</p>
                      <div class="flex items-center">
                          <p class="text-2xl font-bold text-[var(--text)] mr-2">{{averageFromDb}}</p>
                          <div class="flex">
                            <app-rating [rating]="averageFromDb" [reviewCount]="undefined"></app-rating>
                          </div>
                      </div>
                  </div>
                  <div class="flex items-center">
                    <span [class.text-green-500]="hasIncreased(currentWeekRating, lastWeekRating)"
                          [class.text-red-500]="!hasIncreased(currentWeekRating, lastWeekRating)"
                          class="text-sm font-medium flex items-center">
                        <svg [class.rotate-180]="!hasIncreased(currentWeekRating, lastWeekRating)"
                             class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                        {{ ratingChangePercentage | number:'1.0-1' }}% vs last week
                    </span>
                </div>
              </div>
          </div>
      </div>

      <!-- Search and Filter -->
      <div class="mb-6 flex flex-col md:flex-row items-center gap-4">
        <!-- Search Input -->
        <input
          type="text"
          [(ngModel)]="searchTerm"
          placeholder="Search reviews..."
          class="w-full md:w-1/3 px-4 py-2 border border-[var(--background)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)] bg-[var(--surface)] text-[var(--text)]"
        >
        <!-- Search mode -->
        <div class="search-options">
  <label>
    <input type="radio" name="searchMode" [(ngModel)]="searchMode"  value="both"> 
    Search Both
  </label>
  <label>
    <input type="radio" name="searchMode" [(ngModel)]="searchMode" value="email"> 
    Email Only
  </label>
  <label>
    <input type="radio" name="searchMode" [(ngModel)]="searchMode" value="comment"> 
    Comments Only
  </label>
</div>
      
        <!-- Filter by Product Dropdown -->
        <select
          [(ngModel)]="selectedProduct"
          class="w-full md:w-1/3 px-4 py-2 border border-[var(--background)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)] bg-[var(--surface)] text-[var(--text)]"
        >
          <option value="">All Products</option>
          @for (prod of products; track prod.id) {
            <option >{{ prod.nom }}</option>
          }
        </select>
      </div>
      

      @if (isLoading) {
          <div class="flex justify-center items-center h-64">
              <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[var(--primary)]"></div>
          </div>
      } @else if (errorMessage) {
          <div class="p-4 mb-4 bg-red-100 text-red-700 rounded-md">
              {{ errorMessage }}
          </div>
      } @else {
          <div class="overflow-x-auto bg-[var(--surface)] rounded-lg shadow-md">
              <table class="w-full">
                  <thead class="bg-[var(--background)]">
                      <tr>
                        <th 
                        class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)] "
                        
                      >
                      <!-- cursor-pointer -->
                      <!-- (click)="sortByRating()" -->
                        <div class="flex items-center">
                          Review
                          <!-- <span class="ml-1">
                            @if (sortDirection() === 'asc') {
                              <svg class="w-4 h-4 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                              </svg>
                            } @else if (sortDirection() === 'desc') {
                              <svg class="w-4 h-4 text-[var(--primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                              </svg>
                            }
                             @else {
                              <svg class="w-4 h-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                              </svg>
                            }
                          </span> -->
                        </div>
                      </th>
                          <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Product Name</th>
                          <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Customer Email</th>
                          <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Actions</th>
                      </tr>
                  </thead>
                  <tbody>
                      @for (review of reviews(); track review.id) {
                          <tr class="border-t border-[var(--border)] hover:bg-[var(--background)] transition-colors">
                              <td class="px-4 py-4 text-sm text-[var(--text)] max-w-2xl">
                                  <!-- Rating with date -->
                                  <div class="flex items-center mb-2">
                                      <app-rating [rating]="review.note" [reviewCount]="undefined"></app-rating>
                                      <span class="ml-2 text-sm font-medium text-[var(--text)]">
                                          ({{ review.note }})
                                      </span>
                                      <span class="ml-4 text-xs text-gray-500">
                                          {{ review.datePublication | date:'dd/MM/yyyy HH:mm' }}
                                      </span>
                                  </div>
                                  <!-- Review content -->
                                   <app-expand-long-text [text]="review.commentaire" [id]="review.id"></app-expand-long-text>
                              </td>
                              <td class="px-4 py-4 text-sm text-[var(--text)]">{{ review.produit.nom }}</td>
                              <td class="px-4 py-4 text-sm text-[var(--text)]">{{ review.utilisateur.email }}</td>
                              <td class="px-4 py-4 text-sm flex gap-3">
                                  <button
                                      (click)="deleteReview(review.id)"
                                      class="text-red-600 hover:text-red-800"
                                      title="Delete"
                                  >
                                      <span class="material-icons">delete</span>
                                  </button>
                              </td>
                          </tr>
                      }
                      @if (reviews().length === 0) {
                          <tr class="border-t border-gray-200">
                              <td colspan="4" class="px-6 py-4 text-center text-sm text-[var(--text)]">
                                  No reviews found
                              </td>
                          </tr>
                      }
                  </tbody>
              </table>
          </div>

          <!-- Pagination -->
          <div class="mt-6">
              <app-pagination 
                  [currentPage]="currentPage()"
                  [itemsPerPage]="itemsPerPage"
                  [totalItems]="totalElements()"
                  (pageChange)="onPageChange($event)">
              </app-pagination>
          </div>
      }
  </div>
</div>