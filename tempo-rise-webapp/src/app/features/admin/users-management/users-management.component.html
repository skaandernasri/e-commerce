<div class="container mx-auto px-4 py-6">
  <div class="bg-[var(--surface)] rounded-lg shadow-md p-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <h2 class="text-2xl font-bold text-[var(--text)]">Users Management</h2>
      <button class="px-4 py-2 bg-[var(--primary)] text-white rounded-md hover:bg-[var(--secondary)] transition-colors whitespace-nowrap"
              (click)="openCreateUser()">
        Add New User
      </button>
    </div>
  
    <!-- Filters -->
    <div class="mb-6">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="filterUsers()"
        placeholder="Search for users..."
        class="w-full md:w-1/3 px-4 py-2 border border-[var(--background)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)] bg-[var(--surface)] text-[var(--text)]"
      >
      <div class="my-4"></div>
    <div class="mb-6">
      <select [(ngModel)]="selectedRole"
              (change)="filterUsers()"
              class="w-full md:w-1/3 px-4 py-2 border border-[var(--background)] rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--primary)] bg-[var(--surface)] text-[var(--text)]">
        @for(role of roles; track role) {
          <option [value]="role">{{role}}</option>
        }
      </select>
    </div>

    <!-- Content -->
    @if (isLoading) {
      <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[var(--primary)]"></div>
      </div>
    } @else if (errorMessage) {
      <div class="p-4 mb-4 bg-red-100 text-red-700 rounded-md">
        {{ errorMessage }}
      </div>
    } @else {
      <div class="overflow-x-auto rounded-lg">
        <table class="w-full min-w-[600px]">
          <thead class="bg-[var(--background)]">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">#</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Email</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Username</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Phone number</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Roles</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">State</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">loaylty</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-[var(--text)]">Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (filteredUsers.length === 0) {
              <tr>
                <td colspan="6" class="px-4 py-6 text-center text-sm text-[var(--text)]">
                  No users found 
                </td>
              </tr>
            } @else {
              @for (user of paginatedUsers; track user.id; let i = $index) {
                <tr class="border-t border-[var(--border)] hover:bg-[var(--background)] transition-colors">
                  <td class="px-4 py-4 text-sm text-[var(--text)]">{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                  <td class="px-4 py-4 text-sm text-[var(--text)]">{{ user.email }}</td>
                  <td class="px-4 py-4 text-sm text-[var(--text)]">{{ user.prenom===null ? "" + " " + user.nom : user.prenom+" "+user.nom }}</td>
                  <td class="px-4 py-4 text-sm text-[var(--text)]">{{ user.telephone }}</td>
                  <td class="px-4 py-4 text-sm">
                    <div class="flex flex-wrap gap-1">
                      @for (role of user.roles; track role) {
                        <span class="px-2 py-1 bg-[var(--background)] rounded-full text-xs">
                          {{ role }}
                        </span>
                      }
                    </div>
                  </td>
                  <td class="px-4 py-4">
                    @if(user.status === 'Verified') {
                      <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                        {{ user.status }}
                      </span>
                    }
                    @else {
                      <span class="px-2 py-1 rounded-full text-xs bg-red-100 text-red-800">
                        {{ user.status }}
                      </span>
                    }
                  </td>
                  <td class="px-4 py-4 text-sm">
                    @if(user.loyaltyGroup===0){
                  <span
                    class="inline-block bg-[#cd7f32] text-white text-xs font-medium text-center px-3 py-1 rounded-full min-w-[70px]"
                  >
                    Starter
                  </span>
                  }
                  @if(user.loyaltyGroup===1){
                  <span
                    class="inline-block bg-[#c0c0c0] text-black text-xs font-medium text-center px-3 py-1 rounded-full min-w-[70px]"
                  >
                    Pro
                  </span>
                }
                @if (user.loyaltyGroup === 2) {
                  <span
                    class="inline-block bg-[#ffd700] text-white text-xs font-medium text-center px-3 py-1 rounded-full min-w-[70px]"
                  >
                    Elite
                  </span>
                  }
                </td>

                  <td class="px-4 py-4 text-sm flex gap-3">
                    <button (click)="editUser(user.id)"
                            class="text-blue-600 hover:text-blue-800 p-1 rounded-full hover:bg-blue-50"
                            title="Edit">
                      <span class="material-icons text-lg">edit</span>
                    </button>
                    <button (click)="openEmailForm(user)"
                      class="text-green-600 hover:text-green-800 p-1 rounded-full hover:bg-green-50"
                      title="Send Email">
                      <span class="material-icons text-lg">email</span>
                    </button>

                    <button (click)="deleteUser(user.id)"
                            class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-50"
                            title="Delete">
                      <span class="material-icons text-lg">delete</span>
                    </button>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="mt-6">
        <app-pagination 
          [currentPage]="currentPage"
          [itemsPerPage]="itemsPerPage"
          [totalItems]="filteredUsers.length"
          (pageChange)="onPageChange($event)">
        </app-pagination>
      </div>
    }
  </div>
</div>
<!-- EmailForm Modal -->
 @if(showEmailForm){
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-[var(--surface)] rounded-lg shadow-md p-6 w-full max-w-md">
    <h2 class="text-2xl font-bold text-[var(--text)] mb-4">Send Email</h2>
    <form [formGroup]="emailForm" (ngSubmit)="sendEmail()">

      <!-- Subject -->
      <label class="block text-[var(--text)] mb-1" for="subject">Subject</label>
      <input id="subject" formControlName="subject" type="text" required
             class="w-full px-3 py-2 rounded border border-gray-300 mb-4 text-[var(--text)] bg-[var(--surface)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"/>

      <!-- Text -->
      <label class="block text-[var(--text)] mb-1" for="text">Message</label>
      <textarea id="text" formControlName="text" rows="4" required
                class="w-full px-3 py-2 rounded border border-gray-300 mb-4 text-[var(--text)] bg-[var(--surface)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"></textarea>

      <!-- Type -->
      <label class="block text-[var(--text)] mb-1" for="type">Email Type</label>
      <select id="type" formControlName="type" required
              class="w-full px-3 py-2 rounded border border-gray-300 mb-4 text-[var(--text)] bg-[var(--surface)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
        <option value="codePromo">Promo Code</option>
      </select>

      <!-- Code Promo (only show if type == 'codePromo') -->
       @if(emailForm.get('type')?.value === 'codePromo'){
      <div>
        <label class="block text-[var(--text)] mb-1" for="codePromo">Promo Code</label>
        <input id="codePromo" formControlName="codePromo" type="text"
               class="w-full px-3 py-2 rounded border border-gray-300 mb-4 text-[var(--text)] bg-[var(--surface)] focus:outline-none focus:ring-2 focus:ring-[var(--primary)] uppercase"/>
      </div>
    }

      <div class="flex justify-end space-x-2">
        <button type="button" (click)="closeEmailForm()" 
                class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">Cancel</button>
                @if(sendButtonIsLoading){
                  <button [disabled]="true" type="submit" class="px-4 py-2 bg-[var(--primary)] text-white rounded hover:bg-[var(--secondary)]">
                    <div class="flex justify-center items-center">
                      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2"></div>
                    </div>
                  </button>
                }
                @else {
                      <button type="submit" 
                class="px-4 py-2 bg-[var(--primary)] text-white rounded hover:bg-[var(--secondary)]" 
                [disabled]="emailForm.invalid">Send</button>
                }
    
      </div>

    </form>
  </div>
</div>
 }
